#define _DEFAULT_SOURCE

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <time.h>

// ==========================================
// カラー＆スタイル定義
// ==========================================
#define CLR_RESET  "\033[0m"
#define CLR_BOLD   "\033[1m"
#define CLR_PINK   "\033[38;5;205m"
#define CLR_CYAN   "\033[38;5;51m"
#define CLR_GOLD   "\033[38;5;220m"
#define CLR_RED    "\033[38;5;196m"
#define CLR_GRAY   "\033[38;5;244m"
#define BG_BUTTON  "\033[48;5;238m"
#define BG_HEADER  "\033[48;5;235m"

// ==========================================
// 構造体定義
// ==========================================
typedef struct {
    char name[50];
    int love;
    int current_scene; // 1:朝, 2:昼, 3:放課後
} Player;

typedef struct {
    char text[200];
    int required_love;
    int love_points;
} Option;

// ==========================================
// システム・UI関数
// ==========================================
void clear_screen() {
    printf("\033[H\033[J");
}

void clear_input_buffer() {
    int c;
    while ((c = getchar()) != '\n' && c != EOF);
}

void save_game(Player p) {
    FILE *fp = fopen("save.dat", "wb");
    if (fp == NULL) {
        printf("\n " CLR_RED "※ セーブに失敗しました。" CLR_RESET "\n");
        return;
    }
    fwrite(&p, sizeof(Player), 1, fp);
    fclose(fp);
    printf("\n " CLR_GRAY ">> ゲームを保存しました。" CLR_RESET "\n");
    usleep(1000000);
}

int load_game(Player *p) {
    FILE *fp = fopen("save.dat", "rb");
    if (fp == NULL) return 0;
    fread(p, sizeof(Player), 1, fp);
    fclose(fp);
    return 1;
}

void draw_header(Player p) {
    printf(BG_HEADER CLR_BOLD CLR_CYAN);
    printf(" ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ \n");
    printf("  PLAYER: %-15s   LOVE: %3d pts   STATUS: ", p.name, p.love);
    if (p.love >= 100) printf(CLR_PINK "LOVERS" CLR_CYAN);
    else if (p.love >= 50) printf(CLR_GOLD "FRIEND+" CLR_CYAN);
    else printf("FRIEND");
    printf("                                \n");
    printf(" ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ \n");
    printf(CLR_RESET "\n");
}

void draw_box_top(int width) {
    printf(" ╭");
    for (int i = 0; i < width; i++) printf("─");
    printf("╮\n");
}

void draw_box_bottom(int width) {
    printf(" ╰");
    for (int i = 0; i < width; i++) printf("─");
    printf("╯\n");
}

void msg(const char* text, const char* style, int speed_ms) {
    int width = 70;
    draw_box_top(width);
    printf(" │ %s", style);
    
    for (int i = 0; text[i] != '\0'; i++) {
        putchar(text[i]);
        fflush(stdout);
        if (text[i] == '\n') {
            printf(CLR_RESET " │\n │ %s", style);
        }
        usleep(speed_ms * 1000);
    }
    
    printf(CLR_RESET "\n");
    draw_box_bottom(width);
    usleep(500000);
}

int choice_with_req(const char* turn_title, Option options[], int option_count, Player *p) {
    printf("\n " CLR_BOLD CLR_GOLD "【 %s 】" CLR_RESET "\n\n", turn_title);
    
    int valid_choices[10];
    int valid_count = 0;
    
    for (int i = 0; i < option_count; i++) {
        if (p->love >= options[i].required_love) {
            printf("   " BG_BUTTON CLR_BOLD " %d " CLR_RESET "  %s\n\n", i + 1, options[i].text);
            valid_choices[valid_count++] = i + 1;
        } else {
            printf("   " CLR_GRAY "[X]  %s (必要好感度: %d)" CLR_RESET "\n\n", 
                   options[i].text, options[i].required_love);
        }
    }
    
    char input[10];
    while (1) {
        printf(" " CLR_CYAN "▶ 選択 (Sでセーブ): " CLR_RESET);
        if (scanf("%s", input) != 1) {
            clear_input_buffer();
            continue;
        }
        
        if (strcmp(input, "S") == 0 || strcmp(input, "s") == 0) {
            save_game(*p);
            continue;
        }
        
        int choice = atoi(input);
        for (int i = 0; i < valid_count; i++) {
            if (choice == valid_choices[i]) return choice;
        }
        
        printf(" " CLR_RED "※ 有効な番号を入力してください。" CLR_RESET "\n");
    }
}

// ==========================================
// ゲームメイン
// ==========================================
void play() {
    Player p = {"まりこ", 0, 1};
    srand(time(NULL));
    
    clear_screen();
    printf("\n\n" CLR_BOLD CLR_PINK);
    printf("    ♥  Unlock My Heart: Save & Load Edition  ♥    \n");
    printf(CLR_RESET "\n");

    Player loaded_p;
    if (load_game(&loaded_p)) {
        printf(" セーブデータが見つかりました。ロードしますか？ (y/n): ");
        char c;
        scanf(" %c", &c);
        clear_input_buffer();
        if (c == 'y' || c == 'Y') {
            p = loaded_p;
            printf("\n " CLR_CYAN ">> おかえりなさい、%sさん！" CLR_RESET "\n", p.name);
            usleep(1000000);
        } else {
            printf(" 名前を入力してください: ");
            char input_name[50];
            if (fgets(input_name, sizeof(input_name), stdin) != NULL) {
                input_name[strcspn(input_name, "\n")] = '\0';
                if (strlen(input_name) > 0) strcpy(p.name, input_name);
            }
        }
    } else {
        printf(" 名前を入力してください: ");
        char input_name[50];
        if (fgets(input_name, sizeof(input_name), stdin) != NULL) {
            input_name[strcspn(input_name, "\n")] = '\0';
            if (strlen(input_name) > 0) strcpy(p.name, input_name);
        }
    }

    const char* h_name = CLR_PINK "石川" CLR_RESET;
    char temp_msg[500];

    // --- シーン1: 朝 ---
    if (p.current_scene <= 1) {
        p.current_scene = 1;
        clear_screen();
        draw_header(p);
        snprintf(temp_msg, sizeof(temp_msg), "朝登校すると%sが私の前を歩いていた。\n私は%sが好き。全部が大好き。", h_name, h_name);
        msg(temp_msg, CLR_RESET, 30);

        Option opts1[] = {
            {"「おはよう」と普通に挨拶する", 0, 20},
            {"「今日も会えて嬉しいよ」と伝える", 15, 30},
            {"じっと顔を見つめる", 0, 10}
        };
        int ans1 = choice_with_req("朝の校門", opts1, 3, &p);
        p.love += opts1[ans1-1].love_points;

        clear_screen();
        draw_header(p);
        if (ans1 == 1) {
            snprintf(temp_msg, sizeof(temp_msg), "%s「おはよ！ 朝から元気だね」", h_name);
            msg(temp_msg, CLR_PINK, 30);
        } else if (ans1 == 3) {
            snprintf(temp_msg, sizeof(temp_msg), "%s「な、なに？ 私の顔に何かついてる？」", h_name);
            msg(temp_msg, CLR_PINK, 30);
        }
        p.current_scene = 2;
    }

    // --- シーン2: 昼休み ---
    if (p.current_scene <= 2) {
        p.current_scene = 2;
        clear_screen();
        draw_header(p);
        snprintf(temp_msg, sizeof(temp_msg), "お昼休み。%sは一人でパンを食べている。", h_name);
        msg(temp_msg, CLR_RESET, 30);

        Option opts2[] = {
            {"購買のパンを一緒に食べる", 0, 10},
            {"手作りのお弁当を一口あげる", 20, 25},
            {"少し離れた席から見つめる", 0, 0}
        };
        int ans2 = choice_with_req("昼休みの教室", opts2, 3, &p);
        p.love += opts2[ans2-1].love_points;

        clear_screen();
        draw_header(p);
        if (ans2 == 2) {
            snprintf(temp_msg, sizeof(temp_msg), "%s「えっ……。……いいよ。はい、あーん」", h_name);
            msg(temp_msg, CLR_PINK, 30);
        } else {
            snprintf(temp_msg, sizeof(temp_msg), "%s「もぐもぐ……やっぱりここのパン最高！」", h_name);
            msg(temp_msg, CLR_RESET, 30);
        }
        p.current_scene = 3;
    }

    // --- シーン3: 放課後 ---
    if (p.current_scene <= 3) {
        p.current_scene = 3;
        clear_screen();
        draw_header(p);
        msg("放課後。夕暮れの教室に二人きりになった。", CLR_RESET, 30);

        Option opts3[] = {
            {"「また明日」と帰る", 0, 0},
            {"「一緒に帰らない？」と誘う", 30, 20},
            {"「ずっと好きだった」と告白する", 50, 100}
        };
        int ans3 = choice_with_req("夕暮れの教室", opts3, 3, &p);
        p.love += opts3[ans3-1].love_points;
        p.current_scene = 4; // 終了
    }

    // --- エンディング ---
    clear_screen();
    draw_header(p);
    msg("…………数分後。", CLR_RESET, 50);

    if (p.love >= 100) {
        snprintf(temp_msg, sizeof(temp_msg), "%s「私も、ずっと同じ気持ちだったよ……」", h_name);
        msg(temp_msg, CLR_PINK CLR_BOLD, 30);
        printf("\n" CLR_GOLD "  【 TRUE END: 繋がった心と体 】  " CLR_RESET "\n\n");
    } else if (p.love >= 40) {
        snprintf(temp_msg, sizeof(temp_msg), "%s「今日は楽しかったね。また明日も話そう？」", h_name);
        msg(temp_msg, CLR_RESET, 30);
        printf("\n" CLR_CYAN "  【 HAPPY END: 予感 】  " CLR_RESET "\n\n");
    } else {
        snprintf(temp_msg, sizeof(temp_msg), "%s「じゃあね、バイバイ！」", h_name);
        msg(temp_msg, CLR_RESET, 30);
        printf("\n" CLR_GRAY "  【 NORMAL END: ただのクラスメイト 】  " CLR_RESET "\n\n");
    }
    
    // 終了時にセーブデータを消去するか確認（クリア後なので）
    printf(" クリアおめでとうございます！セーブデータを削除しますか？ (y/n): ");
    char sc;
    scanf(" %c", &sc);
    if (sc == 'y' || sc == 'Y') remove("save.dat");

    printf("\n 終了するにはEnterを押してください...");
    clear_input_buffer();
    getchar();
}

int main() {
    play();
    return 0;
}
